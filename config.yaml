# Job specs define the configuration for Bacalhau jobs
jobs:
- id: metadata-job # This is the key used when looking for a job
  type: bacalhau # This job will run on the Bacalhau executor
  image: ghcr.io/bacalhau-project/amplify/tika:v0.0.0-3-gbdaf5ae
  entrypoint: ["extract-metadata", "/inputs", "/outputs"] # Container entrypoint
- id: merge-job
  image: ubuntu
  entrypoint:
  - bash
  - -c
  - >-
    if [ -d /inputs ] ; then cp -r /inputs/* /outputs ; else cp /inputs /outputs/blob ; fi &&
    find / -iwholename '/inputs*metadata.json' | while read line ; do
    result=$(
    echo $line |
    sed 's/\(.*\)outputs\//\1/g' |
    sed 's/\/inputs[0-9]*//g' |
    sed -r 's/(.+)\//\1./g'
    ) ;
    output=/outputs${result} ;
    mkdir -p $(dirname ${output}) ;
    echo "Copying $line to $output" ;
    cp $line $output
    ; done
- id: tree-job
  image: ubuntu
  entrypoint:
  - bash
  - -c
  - >-
    ls -R /inputs
# A job that accepts a root input and passes it to the output -- the root of all jobs
- id: root-job
  type: internal # This job will run on an internal executor. Internal job, doesn't leave Amplify.
  internal_job_id: root-job # Link to internal job ID, must exist in the codebase

# Amplify Work Graph specification
# Each item in the list is a node in the execution graph. A single request 
# (typically a single CID) runs this whole graph. 
graph:
- id: root-node # This is the root of the dag, where the request CID is placed
  job_id: root-job
  inputs:
  - root: true # Identifies that this is a root node
    path: /inputs # Path where inputs will be placed
  outputs:
  - # id: default # Specify custom output id (default: "default")
    path: /outputs # Path where job places outputs
- id: metadata-node 
  job_id: metadata-job 
  inputs:
  - node_id: root-node
    # output_id: custom_id # Connect to custom output id (default: "default")
    path: /inputs
  outputs:
  - path: /outputs 
- id: merge-node
  job_id: merge-job
  inputs:
  - node_id: root-node
    path: /inputs/src
  - node_id: metadata-node
    # This is an "input", but it doesn't have a path, and so 
    # isn't mounted in the container. It is only used to look at the 
    # stdout for the predicate below.
    predicate: '.*"Content-Type":"image\/jpeg".*' # A regex that must match the stdout of the node_id
  outputs:
  - path: /outputs
- id: tree-node
  job_id: tree-job
  inputs:
  - node_id: metadata-node
    path: /inputs/metadata
  - node_id: merge-node
    path: /inputs/merge
  # No outputs with this job, just prints to stdout
